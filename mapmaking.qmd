---
title: "Mapmaking: JCOIN State-Level Stigma Estimates"
author: "Haoyu Shi"
format: html
editor: visual
---

## Source Data Files

CSV tables generated by [report](/notebooks/report.ipynb): [/models/](/models/)

Data dictionary for the fields included in the CSV tables: [/maps/data_dictionary.xlsx](/maps/data_dictionary.xlsx)

Schema for all fields used to generate the CSV tables: [/schemas/processed/protocol2_wave1_analytic.yaml](/schemas/processed/protocol2_wave1_analytic.yaml)

## Set root directory and Load libraries
Set root directory to the project folder if needed.
```{r setup}
# knitr::opts_knit$set(root.dir = '.')
getwd()
```

```{r, echo=True, warning=False, message=FALSE}
library(tidyverse)
library(ggplot2)
library(sf)
library(usmap)
```

## Read Data

```{r}
csv_files <- list.files('models/', pattern = ".csv$", full.names = TRUE)
national_files <- csv_files[grepl("national", csv_files)]
state_files <- csv_files[grepl("state", csv_files)]
```

The `echo: false` option disables the printing of code (only output is displayed).

## National-Level Estimates
Concatenate national estimates for better readability.
```{r}
national_estimates <- national_files %>%
  lapply(read.csv) %>%
  bind_rows()

national_estimates
```
Viusualize national estimates in bar charts
```{r}
ggplot(national_estimates, aes(x = reorder(var, X_estimate), y = X_estimate)) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.7) +
  geom_errorbar(aes(ymin = X_lci, ymax = X_uci), width = 0.2, color = "red") +
  geom_text(aes(label = round(X_estimate, 2)), hjust = -0.5, color = "black") +
  labs(title = "National-Level OUD Stigma",
       x = "Variables",
       y = "Estimated Stigma Level") +
  theme_minimal() +
  ylim(0, 5) +
  coord_flip()
```

## Mapmaking for state estimates
```{r, warning=False}
df_test <- read_csv(state_files[1])
```
Load US State Map from `usmap` package
```{r}
state_map <- us_map(regions = "states")
```

Join estimates with state map and visualization.
```{r, warning=False}
for (fn in state_files){
  varname <- sub(".*state-(.*?)-estimates.*", "\\1", fn)
  print(varname)
  state_estimate <- read_csv(fn)
  joined_data <- state_map %>% left_join(state_estimate, by=c('abbr'='state_cd'))
  joined_data <- st_as_sf(joined_data)
  
p <- ggplot(joined_data) +
    geom_sf(aes(fill=`_estimate`), color="white") +
    scale_fill_gradient(low = "#FFCCB1", high = "#BF4C09", na.value = "#d5d0ca", name = varname) +
    theme_minimal() +
     theme(panel.grid = element_blank(), 
          axis.text.x = element_blank(), 
          axis.text.y = element_blank())

ggsave(paste0('viz/state-level-estimates-maps/', varname, '.png'), 
       plot=p, width=10, height=6.5, units = "in")

}
```

